{% extends "base.html" %}
{% block title %}Dashboard - CryptoVAT{% endblock %} 
{% block description %}Hey fellow trader / analyst, welcome to CryptoVAT Dashboard. Generate your reports.
{% endblock %} 
{% block og_title %}Dashboard - CryptoVAT{% endblock %} 
{% block og_description %}Hey fellow trader / analyst, welcome to CryptoVAT Dashboard. Generate your reports.{% endblock %} 
{% block keywords %}register, secure access, crypto dashboard, cryptovat, trading tools{% endblock %} 
{% block extra_css %}
 <style>

/* --- MAIN DASHBOARD GRID --- */

.grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 20px;
}

.btn {
    background: var(--bg-card);
    border: 1px solid var(--border);
    color: var(--text-main);
    padding: 20px;
    border-radius: 12px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    width: auto;
    margin-top: 0;
}

.btn svg {
    width: 24px;
    height: 24px;
    margin-bottom: 5px;
}

/* Button Color Variants */
.btn-spot {
    border-color: var(--accent-blue);
    color: var(--accent-blue);
}

.btn-futures {
    border-color: var(--accent-orange);
    color: var(--accent-orange);
}

.btn-adv {
    border-color: var(--accent-green);
    color: var(--accent-green);
}

.btn-report {
    border-color: var(--accent-purple);
    color: var(--accent-purple);
}

/* --- TERMINAL / LOG DISPLAY --- */

.terminal {
    background: #000;
    padding: 15px;
    border-radius: 12px;
    border: 1px solid var(--border);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    color: var(--text-dim);
    height: 200px;
    overflow-y: auto;
    margin-top: 20px;
}

.log-line {
    margin-bottom: 4px;
}

.log-line.highlight {
    color: #fff;
    border-left: 2px solid var(--accent-green);
    padding-left: 5px;
}

.log-line.error {
    color: #f6465d;
}

/* --- PROGRESS BAR --- */

.progress-container {
    margin-top: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.progress-bar {
    height: 4px;
    background: #2b3139;
    border-radius: 2px;
    margin-top: 5px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    width: 0%; /* Dynamically set by JavaScript */
    background: var(--accent-green);
    transition: width 0.3s;
}

/* --- ADMIN --- */

.admin {
    text-align: center;
    padding: 20px;
    color: var(--text-dim);
    font-size: 0.9rem;
}
 </style>
{% endblock %}

{% block content %}

<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div style="padding:15px; margin-bottom:20px; border-radius:8px; font-weight:bold; background:{{ 'rgba(14,203,129,0.15)' if category == 'success' else 'rgba(246,70,93,0.15)' }}; color:{{ '#0ecb81' if category == 'success' else '#f6465d' }}; border:1px solid {{ '#0ecb81' if category == 'success' else '#f6465d' }};">
              {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="grid">
        <button class="btn btn-spot" onclick="trigger('{{ url_for('tasks.run_spot') }}')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
            SPOT SCAN
        </button>
        <a class="btn btn-futures" href="{{ url_for('tasks.get_futures_data') }}">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            GET FUTURES
        </a>
        <button class="btn btn-adv" onclick="trigger('{{ url_for('tasks.run_advanced') }}')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            ADVANCED
        </button>
        <a class="btn btn-report" href="{{ url_for('main.reports_list') }}">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            REPORTS
        </a>
    </div>

    <div class="progress-container">
        <span style="font-size:0.8rem; color:var(--text-dim);">STATUS</span>
        <span id="percent" style="font-size:0.8rem; font-weight:bold; color:var(--accent-green);">0%</span>
    </div>
    <div class="progress-bar">
        <div id="bar" class="progress-fill"></div>
    </div>

    <div class="terminal" id="term">
        <div class="log-line">> System Ready...</div>
    </div>
</div>

<div class="admin">
    {% if is_admin %}
    <div style="margin-top: 15px; display: flex; justify-content: center;">
        <a href="{{ url_for('main.admin_dashboard') }}" class="btn btn-links" style="width: auto; padding: 10px 20px; font-size: 0.8rem; margin: 0;">ADMIN DASHBOARD</a>
    </div>
    {% endif %}
</div>

<script>
    let busy = false;
    let lastIdx = 0;
    
    function trigger(url) {
        if (busy) return;
        busy = true;
        
        document.getElementById('term').innerHTML = '<div class="log-line">> Starting task...</div>';
        lastIdx = 0;
        document.getElementById('bar').style.width = '5%';
        document.getElementById('percent').innerText = '5%';
        
        fetch(url).then(r => r.json()).then(() => {
            poll();
            logs();
        }).catch(() => {
            busy = false;
        });
    }
    
    function poll() {
        fetch('{{ url_for("tasks.progress") }}').then(r => r.json()).then(data => {
            document.getElementById('bar').style.width = data.percent + '%';
            document.getElementById('percent').innerText = data.percent + '%';
            if (data.status === 'active') {
                setTimeout(poll, 800);
            } else {
                busy = false;
            }
        });
    }
    
    function logs() {
        fetch('{{ url_for("tasks.logs_chunk") }}?last=' + lastIdx).then(r => r.json()).then(data => {
            if (data.logs.length) {
                lastIdx = data.last_index;
                data.logs.forEach(log => {
                    let div = document.createElement('div');
                    div.className = 'log-line ' + (log.includes('Error') ? 'error' : log.includes('Found') ? 'highlight' : '');
                    div.innerText = '> ' + log;
                    document.getElementById('term').appendChild(div);
                });
                document.getElementById('term').scrollTop = 9999;
            }
            if (busy) {
                setTimeout(logs, 1000);
            }
        });
    }
</script>
{% endblock %}